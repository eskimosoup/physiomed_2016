var markers = [];
var map, locations, latlngbounds, lastMarker;
var infoWindows = [];
var apiKey = 'AIzaSyDw5ll7D-Uln_pW-eDKsC61NaoS2gCQUZo'; // seo.optimisd@gmail.com

function initialize() {
  if (document.getElementById("physio-search-map-canvas")) {
    locations = $('#physio-search-map-canvas').data('locations');

    if (locations) {
      var mapOptions = {
        center: new google.maps.LatLng(53.743317, -0.331004),
        zoom: 18,
        scrollwheel: false
      };

      map = new google.maps.Map(document.getElementById("physio-search-map-canvas"), mapOptions);

      var latLngs = [];
      $.each(locations, function(index, value) {
        var myLatLng = new google.maps.LatLng(value.latitude, value.longitude);
        latLngs[index] = myLatLng;
        var contentString = '<div class="offices-info-window">';

        if (value.name != null) {
          contentString += '<strong>' + value.name + '</strong><br />';
        }

        if (value.address != null) {
          contentString += value.address + '<br />';
        }

        contentString += '</div>';

        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });

        var image = '<%= image_url "icons/google-map-pin.png" %>';

        var marker = new google.maps.Marker({
          position: myLatLng,
          map: map,
          icon: image,
          title: value.street,
          zIndex: index
        });

        google.maps.event.addListener(marker, 'click', function() {
          closeInfoWindow();
          // remove class from previously active location
          if (lastMarker != null) {
            $('.physio-search-result-' + lastMarker).removeClass('active');
          }

          lastMarker = markers.indexOf(marker);
          $('.physio-search-result-' + lastMarker).toggleClass('active');
          map.panTo(marker.getPosition());
          //pan and then wait 2 secs then zoom and open info window
          window.setTimeout(function() {
            map.setZoom(18);
            infowindow.open(map, marker);
          }, 1000);
        });

        google.maps.event.addListener(map, 'click', function(event) {
          this.setOptions({
            scrollwheel: true
          });
        });

        google.maps.event.addListener(infowindow, 'closeclick', function() {
          if(latLngs.length > 1) {
            map.fitBounds(latlngbounds);
          }
          $('.physio-search-result-' + lastMarker).toggleClass('active');
        });

        //add info window and marker to respective arrays
        infoWindows.push(infowindow);
        markers.push(marker);
      });

      latlngbounds = new google.maps.LatLngBounds();
      $.each(latLngs, function(index, n) {
        latlngbounds.extend(n);
      });
      map.setCenter(latlngbounds.getCenter());
      if(latLngs.length > 1) {
        map.fitBounds(latlngbounds);
      }
    }
  }
}

function closeInfoWindow() {
  if (lastMarker != null) {
    infoWindows[lastMarker].close();
  }
}

function loadScript() {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&callback=initialize';
  script.async = 'async';
  script.defer = 'defer';
  document.body.appendChild(script);
}

// The function to trigger the marker click, 'id' is the reference index to the 'markers' array.
function locationClick(id) {
  google.maps.event.trigger(markers[id], 'click');
}

window.onload = loadScript;
